<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>教員出欠WEB</title>
  <style>
    body { margin: 0; padding: 10px; font-family: sans-serif; }
    table { border-collapse: collapse; min-width: 900px; }
    th, td { border: 1px solid #000; padding: 6px; text-align: center; white-space: nowrap; }
    input, select { font-size: 16px; width: 100%; box-sizing: border-box; color: black; text-align: center; }

    /* --- 名前セル --- */
    .fixed-name { position: sticky; left: 0; background: #fff; z-index: 2; min-width: calc(6em + 48px); }
    .name-cell { display:flex; align-items:center; gap:6px; }
    .name-cell .btns { display:flex; flex-direction:column; gap:4px; }
    .name-cell button { width:28px; height:24px; padding:0; }
    .name-input { width: 6em; }

    /* --- イベント列ヘッダ --- */
    .col-head { display:flex; align-items:center; gap:6px; justify-content:center; }
    .col-head button { width:28px; height:24px; padding:0; }
    .event-input { width: 7em; }

    .table-container { overflow-x: auto; width: 100%; }
    .controls { margin: 10px 0; display: flex; flex-wrap: wrap; gap: 10px; }
    #noticeArea { margin: 20px 0; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; }
    #noticeText { width: 100%; height: 100px; font-size: 18px; }

    @media (max-width: 768px) {
      th, td, select, input { font-size: 14px; padding: 4px; }
      #noticeText { font-size: 16px; height: 80px; }
      .fixed-name { min-width: calc(6em + 46px); }
    }
    @media print { button, input, textarea, select { display: none; } }
  </style>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD9OakYyH-ONyGRvkPbVzxODrg4lyWcKq4",
      authDomain: "teacherlist-dfac5.firebaseapp.com",
      databaseURL: "https://teacherlist-dfac5-default-rtdb.firebaseio.com",
      projectId: "teacherlist-dfac5",
      storageBucket: "teacherlist-dfac5.appspot.com",
      messagingSenderId: "504608468919",
      appId: "1:504608468919:web:a9499106714e9f23c2c232"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let names = [];
    let events = [];
    let attendanceData = {};
    let eventOrder = [];

    function saveToFirebase(name, event, value) {
      db.ref(`attendance/${name}/${event}`).set(value);
    }

    function saveName(index) {
      const oldName = names[index];
      const newName = document.getElementById(`name-input-${index}`).value.trim();
      if (!newName || oldName === newName) return;
      const oldData = attendanceData[oldName] || {};
      db.ref(`attendance/${newName}`).set(oldData);
      db.ref(`attendance/${oldName}`).remove();
      db.ref(`names/${index}`).set(newName);
      names[index] = newName;
      renderTable();
    }

    function saveEvent(index) {
      const newEvent = document.getElementById(`event-input-${index}`).value;
      db.ref(`events/${index}`).set(newEvent);
      events[index] = newEvent;
      renderTable();
    }

    function moveName(index, delta) {
      const j = index + delta;
      if (j < 0 || j >= names.length) return;
      [names[index], names[j]] = [names[j], names[index]];
      const updates = {};
      updates[`names/${index}`] = names[index];
      updates[`names/${j}`] = names[j];
      db.ref().update(updates);
      renderTable();
    }

    function moveEvent(pos, delta) {
      if (!eventOrder.length) eventOrder = events.map((_, i) => String(i));
      const newPos = pos + delta;
      if (newPos < 0 || newPos >= eventOrder.length) return;
      [eventOrder[pos], eventOrder[newPos]] = [eventOrder[newPos], eventOrder[pos]];
      saveEventOrder(eventOrder);
      renderTable();
    }
    function saveEventOrder(arr) {
      db.ref("eventOrder").set(arr.map(String));
    }

    function addName() {
      const newName = `教員${names.length + 1}`;
      names.unshift(newName);
      const payload = {};
      names.forEach((n, i) => payload[i] = n);
      db.ref("names").set(payload);
      renderTable();
    }

    // ★ 列を先頭に追加（最左）に修正
    function addEvent() {
      const newEvent = `イベント${events.length + 1}`;
      const index = events.length;
      events.push(newEvent);
      db.ref(`events/${index}`).set(newEvent);

      if (!eventOrder.length) {
        eventOrder = events.map((_, i) => String(i));
      } else {
        eventOrder.unshift(String(index)); // 先頭に追加
      }
      saveEventOrder(eventOrder);
      renderTable();
    }

    function loadFromFirebase() {
      db.ref("attendance").on("value", s => { attendanceData = s.val() || {}; renderTable(); });
      db.ref("names").on("value", s => {
        const d = s.val();
        if (d) {
          const maxIndex = Math.max(...Object.keys(d).map(k => parseInt(k, 10)));
          names = Array.from({ length: maxIndex + 1 }, (_, i) => d[i] ?? `教員${i+1}`);
        }
        renderTable();
      });
      db.ref("events").on("value", s => {
        const d = s.val();
        if (d) {
          const maxIndex = Math.max(...Object.keys(d).map(k => parseInt(k, 10)));
          events = Array.from({ length: maxIndex + 1 }, (_, i) => d[i] ?? `イベント${i+1}`);
        }
        renderTable();
      });
      db.ref("eventOrder").on("value", s => {
        const d = s.val();
        eventOrder = Array.isArray(d) ? d.map(String) : [];
        renderTable();
      });
    }

    function currentEventIndexOrder() {
      return eventOrder.length
        ? eventOrder.map(x => parseInt(x, 10)).filter(i => events[i] !== undefined)
        : events.map((_, i) => i);
    }

    function renderTable() {
      const order = currentEventIndexOrder();
      const theadRow = document.getElementById("headerRow");
      theadRow.innerHTML = '<th class="fixed-name">名前</th>';
      order.forEach((eventIdx, pos) => {
        const event = events[eventIdx] ?? "";
        theadRow.innerHTML += `
          <th>
            <div class="col-head">
              <button onclick="moveEvent(${pos}, -1)">←</button>
              <input class="event-input" id="event-input-${eventIdx}" value="${event}" onchange="saveEvent(${eventIdx})" />
              <button onclick="moveEvent(${pos}, 1)">→</button>
            </div>
            <div>
              ○:<span id="countYes${pos}">0</span>
              △:<span id="countMaybe${pos}">0</span>
              ✕:<span id="countNo${pos}">0</span>
            </div>
          </th>`;
      });

      const tbody = document.querySelector("tbody");
      tbody.innerHTML = "";
      names.forEach((name, i) => {
        let row = `<tr><td class="fixed-name">
          <div class="name-cell">
            <div class="btns">
              <button onclick="moveName(${i}, -1)">↑</button>
              <button onclick="moveName(${i}, 1)">↓</button>
            </div>
            <input class="name-input" id="name-input-${i}" value="${name}" onchange="saveName(${i})" />
          </div>
        </td>`;
        order.forEach((eventIdx) => {
          const event = events[eventIdx] ?? "";
          const value = attendanceData[name]?.[event] || "";
          row += `<td><select onchange="saveToFirebase('${name}','${event}',this.value); updateCounts();">
            <option value="" ${value===""?"selected":""}></option>
            <option value="○" ${value==="○"?"selected":""}>○</option>
            <option value="△" ${value==="△"?"selected":""}>△</option>
            <option value="✕" ${value==="✕"?"selected":""}>✕</option>
          </select></td>`;
        });
        row += '</tr>';
        tbody.innerHTML += row;
      });
      updateCounts(); updateFilterOptions();
    }

    function updateCounts() {
      const order = currentEventIndexOrder();
      order.forEach((_, pos) => {
        const selects = document.querySelectorAll(`tbody td:nth-child(${pos+2}) select`);
        let yes=0, maybe=0, no=0;
        selects.forEach(sel=>{
          if(sel.value==="○") yes++;
          else if(sel.value==="△") maybe++;
          else if(sel.value==="✕") no++;
        });
        document.getElementById(`countYes${pos}`).textContent=yes;
        document.getElementById(`countMaybe${pos}`).textContent=maybe;
        document.getElementById(`countNo${pos}`).textContent=no;
      });
    }

    function updateFilterOptions() {
      const filter=document.getElementById("filterName");
      const current=filter.value;
      filter.innerHTML='<option value="">全員表示</option>';
      names.forEach(n=>{
        const opt=document.createElement("option");
        opt.value=n; opt.textContent=n;
        filter.appendChild(opt);
      });
      if(current) filter.value=current;
    }
    function filterNames() {
      const selected=document.getElementById("filterName").value;
      document.querySelectorAll("tbody tr").forEach(r=>{
        const name=r.querySelector("input")?.value;
        r.style.display=(!selected||name===selected)?"":"none";
      });
    }

    function downloadExcel() {
      const order=currentEventIndexOrder();
      const headerEvents=order.map(i=>events[i]??"");
      const wsData=[["名前",...headerEvents]];
      document.querySelectorAll("tbody tr").forEach(row=>{
        const rowData=[row.cells[0].querySelector("input")?.value||""];
        for(let i=1;i<row.cells.length;i++){
          const val=row.cells[i].querySelector("select")?.value||"";
          rowData.push(val);
        }
        wsData.push(rowData);
      });
      const wb=XLSX.utils.book_new();
      const ws=XLSX.utils.aoa_to_sheet(wsData);
      XLSX.utils.book_append_sheet(wb,ws,"出欠表");
      XLSX.writeFile(wb,"出欠表.xlsx");
    }

    function loadNotice() {
      db.ref("notice").on("value", s=>{
        document.getElementById("noticeText").value=s.val()||"";
      });
    }
    function saveNotice() {
      db.ref("notice").set(document.getElementById("noticeText").value);
    }

    window.addEventListener("DOMContentLoaded",()=>{
      loadFromFirebase(); loadNotice();
    });
  </script>
</head>
<body>
  <h2>教員出欠WEB</h2>
  <div id="noticeArea">
    <h3>お知らせ欄</h3>
    <textarea id="noticeText" placeholder="ここにお知らせを入力"></textarea><br />
    <button onclick="saveNotice()">保存</button>
  </div>
  <label for="filterName">名前でフィルター：</label>
  <select id="filterName" onchange="filterNames()"></select>
  <div class="table-container">
    <table>
      <thead><tr id="headerRow"></tr></thead>
      <tbody></tbody>
    </table>
  </div>
  <div class="controls">
    <button onclick="addName()">＋ 教員を追加（先頭行）</button>
    <button onclick="addEvent()">＋ イベントを追加（先頭列）</button>
    <button onclick="downloadExcel()">⬇ Excelダウンロード</button>
  </div>
</body>
</html>
